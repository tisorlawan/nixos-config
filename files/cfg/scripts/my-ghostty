#!/usr/bin/env bash

set -euo pipefail

WRITE_CONFIG_ONLY=0
if [ "${1:-}" = "--write-config-only" ]; then
  WRITE_CONFIG_ONLY=1
  shift
fi

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
COLOR_MODE="$($SCRIPT_DIR/color-mode)"

BTOP_DIR="$HOME/.config/btop"
BTOP_CONF="$BTOP_DIR/btop.conf"

# Ensure config directory exists
DIR="$HOME/.config/ghostty"
mkdir -p "$DIR"
TMP_CONFIG="$(mktemp "$DIR/config.XXXXXX")"

# Generate and write config
cat >"$TMP_CONFIG" <<EOF
# AUTOGENERATED CONFIG by ~/.script/my-ghostty

$(if [ "$COLOR_MODE" = "light" ]; then
  echo 'background-opacity = 1.0'
  echo 'background = ffffff'
  echo 'foreground = 111827'
  echo 'cursor-color = 1f2937'
  echo 'cursor-text = f9fafb'
  echo 'selection-background = cfe2ff'
  echo 'selection-foreground = 0f172a'
  echo 'palette = 0=111827'
  echo 'palette = 1=9f1239'
  echo 'palette = 2=166534'
  echo 'palette = 3=854d0e'
  echo 'palette = 4=1d4ed8'
  echo 'palette = 5=7e22ce'
  echo 'palette = 6=0f766e'
  echo 'palette = 7=e5e7eb'
  echo 'palette = 8=4b5563'
  echo 'palette = 9=be123c'
  echo 'palette = 10=15803d'
  echo 'palette = 11=a16207'
  echo 'palette = 12=2563eb'
  echo 'palette = 13=9333ea'
  echo 'palette = 14=0d9488'
  echo 'palette = 15=f9fafb'
else
  echo 'background-opacity = 1.0'
  echo '# background = 18181b'
  echo 'background = 131313'
  echo 'foreground = f3f4f6'
  echo 'cursor-color = e5e7eb'
  echo 'cursor-text = 111827'
  echo 'selection-background = 334155'
  echo 'selection-foreground = f9fafb'
  echo 'palette = 0=1f2937'
  echo 'palette = 1=f87171'
  echo 'palette = 2=4ade80'
  echo 'palette = 3=facc15'
  echo 'palette = 4=60a5fa'
  echo 'palette = 5=c084fc'
  echo 'palette = 6=2dd4bf'
  echo 'palette = 7=f3f4f6'
  echo 'palette = 8=64748b'
  echo 'palette = 9=fca5a5'
  echo 'palette = 10=86efac'
  echo 'palette = 11=fde047'
  echo 'palette = 12=93c5fd'
  echo 'palette = 13=d8b4fe'
  echo 'palette = 14=5eead4'
  echo 'palette = 15=f9fafb'
fi)

font-family = "Berkeley Mono"
font-size = 14
adjust-font-baseline = 1
adjust-cell-height = 2
adjust-underline-position = 2

window-decoration = "none"
window-padding-balance = true
window-padding-x = 0
window-padding-y = 0
maximize = true

class = com.ghostty.tiso
x11-instance-name = ghost
window-padding-color = background
gtk-single-instance = false
adw-toolbar-style = flat
gtk-titlebar-hide-when-maximized = true

cursor-invert-fg-bg = true
clipboard-paste-protection = false

confirm-close-surface = false
app-notifications = no-clipboard-copy

keybind = all:alt+one=unbind
keybind = all:alt+two=unbind
keybind = all:alt+three=unbind
keybind = all:alt+four=unbind
keybind = ctrl+enter=unbind

resize-overlay = never
faint-opacity = 1.0

# vim: ft=config
EOF
mv "$TMP_CONFIG" "$DIR/config"

mkdir -p "$BTOP_DIR"

if [ "$COLOR_MODE" = "light" ]; then
  BTOP_THEME="adwaita"
else
  BTOP_THEME="kanagawa-wave"
fi

if [ -f "$BTOP_CONF" ]; then
  if grep -q '^color_theme\s*=' "$BTOP_CONF"; then
    sed -i "s|^color_theme\s*=.*$|color_theme = \"$BTOP_THEME\"|" "$BTOP_CONF"
  else
    printf '\ncolor_theme = "%s"\n' "$BTOP_THEME" >>"$BTOP_CONF"
  fi
else
  cat >"$BTOP_CONF" <<EOF
color_theme = "$BTOP_THEME"
EOF
fi

if [ "$WRITE_CONFIG_ONLY" -eq 1 ]; then
  exit 0
fi

exec ghostty "$@"
