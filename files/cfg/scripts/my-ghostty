#!/usr/bin/env bash

set -euo pipefail

WRITE_CONFIG_ONLY=0
if [ "${1:-}" = "--write-config-only" ]; then
    WRITE_CONFIG_ONLY=1
    shift
fi

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
COLOR_MODE="$($SCRIPT_DIR/color-mode)"

# Ensure config directory exists
DIR="$HOME/.config/ghostty"
mkdir -p "$DIR"
TMP_CONFIG="$(mktemp "$DIR/config.XXXXXX")"

# Generate and write config
cat > "$TMP_CONFIG" << EOF
# AUTOGENERATED CONFIG by ~/.script/my-ghostty

$(if [ "$COLOR_MODE" = "light" ]; then
    echo '# theme = "Catppuccin Mocha"'
    echo '# background = 131313'
    echo ''
    echo 'theme = "Terminal Basic"'
    echo ''
    echo 'background-opacity = 1.0'
    echo 'background = fcfcfc'
    echo '# background = 181818'
else
    echo 'theme = "Catppuccin Mocha"'
    echo 'background = 131313'
    echo '# theme = "Terminal Basic"'
    echo '# background = fcfcfc'
fi)

font-family = "JetBrainsMono Nerd Font"
font-size = 14
adjust-font-baseline = 1
adjust-cell-height = 0
adjust-underline-position = 1

window-decoration = "none"
window-padding-balance = true
window-padding-x = 0
window-padding-y = 0
maximize = true

class = com.ghostty.tiso
x11-instance-name = ghost
window-padding-color = background
gtk-single-instance = false
adw-toolbar-style = flat
gtk-titlebar-hide-when-maximized = true

cursor-invert-fg-bg = true
clipboard-paste-protection = false

confirm-close-surface = false
app-notifications = no-clipboard-copy

keybind = all:alt+one=unbind
keybind = all:alt+two=unbind
keybind = all:alt+three=unbind
keybind = all:alt+four=unbind
keybind = ctrl+enter=unbind

resize-overlay = never

# vim: ft=config
EOF
mv "$TMP_CONFIG" "$DIR/config"

if [ "$WRITE_CONFIG_ONLY" -eq 1 ]; then
    exit 0
fi

exec ghostty "$@"
