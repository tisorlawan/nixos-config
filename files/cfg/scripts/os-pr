#!/usr/bin/env bash
set -euo pipefail

# TODO: Replace XDG_DATA_HOME workaround with --ephemeral when merged
# See: https://github.com/sst/opencode/issues/4489
EPHEMERAL_DIR="${TMPDIR:-/tmp}/opencode-ephemeral-$$"
mkdir -p "$EPHEMERAL_DIR/opencode"
cp ~/.local/share/opencode/auth.json "$EPHEMERAL_DIR/opencode/" 2>/dev/null || true
export XDG_DATA_HOME="$EPHEMERAL_DIR"
trap 'rm -rf "$EPHEMERAL_DIR"' EXIT

# MODEL="anthropic/claude-sonnet-4-5-20250929"
MODEL="opencode/kimi-k2.5-free"
FORCE_SONNET=false

# Handle flags and arguments
ARGS=()
while [[ $# -gt 0 ]]; do
  case "$1" in
  --sonnet)
    FORCE_SONNET=true
    shift
    ;;
  *)
    ARGS+=("$1")
    shift
    ;;
  esac
done

if [ "${#ARGS[@]}" -ne 1 ]; then
  echo "Usage: $0 [--sonnet] <base-commit>" >&2
  exit 1
fi

BASE_COMMIT=${ARGS[0]}

PROMPT=$(
  cat <<'TEMPLATE'
At the end of this message, I will ask you to create a PR based on the commit hash provided.
To see the diff, just run 
   `git diff --stat BASE_COMMIT_PLACEHOLDER HEAD` or 
   `git diff BASE_COMMIT_PLACEHOLDER HEAD` or 
   `git diff BASE_COMMIT_PLACEHOLDER HEAD -- [file]` when you want to see the diff for [file].

- Create a `PR.md` file (delete if it already exist/truncate it) with the following format:

## Pull Request Title Format

Use Conventional Commits format for PR titles:

```text
<type>(<scope>): <description>
```

## Common Types

- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation changes
- `style`: Code style changes (formatting, no logic changes)
- `refactor`: Code refactoring
- `test`: Adding or updating tests
- `chore`: Maintenance tasks, dependency updates

## Description Field

Recommended to start a `<description>` with a verb (add, resolve, update, etc.)

## Examples

- `feat(auth): add OAuth2 login integration`
- `fix(api): resolve null pointer exception in user service`
- `docs(readme): update installation instructions`
- `refactor(database): optimize query performance`
- `feat(BE): add vector DB connection`
- `fix(FE): login redirection`

## Pull Request Description Format

```markdown
## Summary

<!-- Brief description of what this PR does and why it's needed -->

## How to Test

<!-- Provide clear steps for reviewers to test your changes -->

1. Step 1
2. Step 2
3. Expected result

## Related Issues

<!-- Link related issues using: Closes #123, Fixes #456, Related to #789 -->

## Author Checklist

- [ ] Code follows team coding standards and style guide
- [ ] Self-reviewed the code changes
- [ ] Added/updated tests for new functionality
- [ ] All tests pass locally
- [ ] Code is properly documented
- [ ] Synced with latest `develop` branch
- [ ] PR title follows conventional commit format
- [ ] Meaningful commit messages used

## Additional Notes

1. [GDP Labs Coding and Code Review Best Practices](https://docs.google.com/document/d/1QCzqnxXPEN_fatbTaSt-LVL9vFKoEBrQ6zTCt3tbCWU/edit)
<!-- Any additional context, screenshots, or information reviewers should know -->
```

## Guidelines for Authors

- **Keep PRs Small**: Aim for changes under 200-300 lines when possible
- **Use Draft**: Use Draft when the PR is not ready for review to reduce reviewer overhead
- **Write Clear Descriptions**: Explain the "what" and "why", not just the "how"
- **Test Thoroughly**: Test locally and in development environment before requesting review
- **Use Meaningful Commits**: Each commit should represent a logical unit of work
- **Link Issues**: Always reference related issues or tickets
- **Author Checklist**: Set items as strikethrough if they are not necessary
  - Example: `- [ ] ~Synced with latest develop branch~`

**Note: Do not create PR with gh command - only create the PR.md files with the proper templates.**

TEMPLATE
)

PROMPT=${PROMPT//BASE_COMMIT_PLACEHOLDER/${BASE_COMMIT}}

if [ "$FORCE_SONNET" = true ]; then
  opencode run --model anthropic/claude-sonnet-4-5 "$PROMPT"
else
  # Try Gemini first
  OUTPUT=$(opencode run --model "$MODEL" "$PROMPT" || true)

  if [[ -z "$OUTPUT" ]]; then
    # Fallback to Claude if Gemini fails or produced no output
    opencode run --model anthropic/claude-sonnet-4-5 "$PROMPT"
  else
    echo "$OUTPUT"
  fi
fi
