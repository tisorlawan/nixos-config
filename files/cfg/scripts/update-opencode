#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.12"
# dependencies = [
#     "json5",
# ]
# ///

import json5
import os
import subprocess
import sys

CONFIG_PATH = os.path.expanduser("~/.config/opencode/opencode.jsonc")

def run_command(cmd):
    try:
        result = subprocess.run(cmd, shell=True, check=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
        return result.stdout.strip()
    except subprocess.CalledProcessError:
        return None

def get_repo_for_plugin(plugin_name):
    # Search for the repo using gh cli
    cmd = f"gh search repos {plugin_name} --limit 1 --json fullName -q '.[0].fullName'"
    return run_command(cmd)

def get_latest_version(repo_name):
    # Try getting latest release
    cmd = f"gh release view -R {repo_name} --json tagName -q .tagName"
    tag = run_command(cmd)
    
    if not tag:
        # Fallback to tags if no release found
        cmd = f"gh api repos/{repo_name}/tags --jq '.[0].name'"
        tag = run_command(cmd)
    
    if tag:
        if tag.startswith('v'):
            return tag[1:]
        return tag
    return None

def update_plugins():
    if not os.path.exists(CONFIG_PATH):
        print(f"Config file not found: {CONFIG_PATH}")
        sys.exit(1)

    print(f"Reading config from {CONFIG_PATH}...")
    
    try:
        with open(CONFIG_PATH, 'r') as f:
            data = json5.load(f)
    except Exception as e:
        print(f"Error parsing JSONC: {e}")
        sys.exit(1)

    if 'plugin' not in data:
        print("No 'plugin' section found in config.")
        return

    plugins = data.get('plugin', [])
    new_plugins = []
    
    changed = False

    for plugin_entry in plugins:
        if '@' in plugin_entry:
            name = plugin_entry.split('@')[0]
            current_version = plugin_entry.split('@')[1]
        else:
            name = plugin_entry
            current_version = None
        
        print(f"Processing plugin: {name}")
        
        repo = get_repo_for_plugin(name)
        if repo:
            print(f"  Found repository: {repo}")
            latest_version = get_latest_version(repo)
            
            if latest_version:
                print(f"  Latest version: {latest_version}")
                new_entry = f"{name}@{latest_version}"
                new_plugins.append(new_entry)
                
                if new_entry != plugin_entry:
                    changed = True
                    print(f"  -> Updating from {current_version} to {latest_version}")
                else:
                    print("  -> Already up to date")
            else:
                print(f"  Could not determine latest version for {repo}. Keeping current.")
                new_plugins.append(plugin_entry)
        else:
            print(f"  Could not find repository for {name}. Keeping current.")
            new_plugins.append(plugin_entry)

    if changed:
        data['plugin'] = new_plugins
        with open(CONFIG_PATH, 'w') as f:
            # json5 dump preserves some compatibility but doesn't perfectly preserve comments unfortunately
            # but it is valid JSON5/JSONC
            json5.dump(data, f, indent=4, quote_keys=True)
        print("Config file updated successfully.")
    else:
        print("No changes needed.")

def cleanup():
    print("Cleaning up temporary files...")
    targets = [
        os.path.expanduser("~/.config/opencode/node_modules"),
        os.path.expanduser("~/.config/opencode/bun.lock")
    ]
    
    for target in targets:
        if os.path.exists(target):
            try:
                if os.path.isdir(target):
                    subprocess.run(['rm', '-rf', target], check=True)
                else:
                    os.remove(target)
                print(f"  Removed {target}")
            except Exception as e:
                print(f"  Failed to remove {target}: {e}")
        else:
            print(f"  {target} not found (clean)")

if __name__ == "__main__":
    update_plugins()
    cleanup()
